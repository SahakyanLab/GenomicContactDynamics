Loading R-cbrg/current
  Loading requirement: gsl/2.6 hdf5/1.10.7 gdal/3.2.1 sqlite/3.35.0 proj/7.2.1
    geos/3.9.0 jags/4.3.0

R version 4.1.2 (2021-11-01) -- "Bird Hippie"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ################################################################################
> # Make PERSIST.MX using HiCNorm matrices and make sure that contacts present
> # per tissue and corresponding Cp is identical with PERSIST.MX from raw values.
> ################################################################################
> # FLAGS * FLAGS * FLAGS * FLAGS * FLAGS * FLAGS * FLAGS * FLAGS * FLAGS * FLAGS
> ### DIRECTORY STRUCTURE ########################################################
> whorunsit = "LiezelCluster" # "LiezelMac", "LiezelCluster", "LiezelLinuxDesk",
> # "AlexMac", "AlexCluster"
> 
> if( !is.null(whorunsit[1]) ){
+   # This can be expanded as needed ...
+   if(whorunsit == "LiezelMac"){
+     home.dir = "/Users/ltamon"
+   } else if(whorunsit == "LiezelCluster"){
+     home.dir = "/project/sahakyanlab/ltamon"
+   } else {
+     stop("The supplied <whorunsit> option is not created in the script.", quote=FALSE)
+   }
+ }
> lib = paste0(home.dir, "/DPhil/lib")
> data.dir = paste0(home.dir, "/Database")
> 
> rawpmx.dir = paste0(data.dir, "/HiC_features_GSE87112_RAWpc")
> melt.dir = paste0(data.dir, "/GSE87112/combined_contacts")
> out.dir = paste0(data.dir, "/HiC_features_GSE87112_RAWpc/persist_HiCNorm")
> ### OTHER SETTINGS #############################################################
> melt.id = "HiCNorm_primary_cohort" 
> chr.v = paste0("chr", c(1:22, "X"))
> nCPU = 1L
> gcb = "min05Mb"
> min.dist = ifelse(gcb=="min2Mb", 2000000, 500000)
> hic.resol = 40000
> top.perc = 100
> min.tiss = 1
> ################################################################################
> # LIBRARIES & DEPENDENCIES * LIBRARIES & DEPENDENCIES * LIBRARIES & DEPENDENCIES 
> ################################################################################
> library(foreach)
> library(doParallel)
Loading required package: iterators
Loading required package: parallel
> library(itertools)
> source(paste0(lib, "/UTL_doPar.R"))
> source(paste0(lib, "/TrantoRextr/GEN_getMELTMXpersist.R"))  
> ################################################################################
> # MAIN CODE * MAIN CODE * MAIN CODE * MAIN CODE * MAIN CODE * MAIN CODE *
> ################################################################################
> print(paste0(gcb, " min.dist=", min.dist, " ", melt.id), quote=FALSE)
[1] min05Mb min.dist=5e+05 HiCNorm_primary_cohort
> 
> melt.dir <- paste0(melt.dir, "/", melt.id)
> chr.v.len <- length(chr.v)
> 
> toExport <- c("rawpmx.dir", "melt.dir", "out.dir", "chr.v", "min.dist", 
+               "hic.resol", "top.perc", "min.tiss", "gcb")
> #### PARALLEL EXECUTION #########
> foreach(itr=isplitVector(1:chr.v.len, chunks=nCPU), 
+         .inorder=TRUE, .export=toExport, .noexport=ls()[!ls()%in%toExport]
+         
+ ) %op% {
+   
+   for(i in itr){
+     chr <- chr.v[i]
+     load(paste0(melt.dir, "/human_", chr, "_allcontacts.RData"))
+     PERSIST.MX <- getMELTMXpersist(MELT.MX=MELT.MX, min.dist=min.dist,
+                                    hic.resol=hic.resol, top.perc=top.perc,
+                                    min.tiss=min.tiss)
+     rm(MELT.MX); gc()
+     save(PERSIST.MX, file=paste0(out.dir, "/", chr, "_Persist_", gcb, ".RData"))
+ 
+     newPMX <- PERSIST.MX
+     rm(PERSIST.MX); gc()
+     ct.v <- setdiff(colnames(newPMX$hits), c("i","j"))
+     if( (length(ct.v)!=ncol(newPMX$hits)-2) ){ stop(paste0(chr, ": Checkpoint")) }
+     
+     #-------------------Compare with PERSIST.MX made from raw Cs
+     load(paste0(rawpmx.dir, "/", chr, "_Persist_", gcb, ".RData"))
+     
+     if( !identical(PERSIST.MX$control, newPMX$control) ){
+       print(paste0(chr, ": Control not consistent."), quote=FALSE)
+     } 
+   
+     # Identical Cps?
+     if( !identical(PERSIST.MX$ntis, newPMX$ntis) ){
+       print(paste0(chr, ": Cp not consistent."), quote=FALSE)
+       next
+     } 
+     
+     # Identical ij?
+     if( !identical(PERSIST.MX$hits[,c("i","j")], newPMX$hits[,c("i","j")]) ){
+       print(paste0(chr, ": ij not consistent."), quote=FALSE)
+       next
+     } 
+     
+     PERSIST.MX$hits <- data.matrix(PERSIST.MX$hits[,ct.v])
+     PERSIST.MX$hits[PERSIST.MX$hits!=0] <- 1
+     newPMX$hits <- data.matrix(newPMX$hits[,ct.v])
+     newPMX$hits[newPMX$hits!=0] <- 1
+     
+     # Identical set of contacts per tissue?
+     if( !identical(PERSIST.MX$hits, newPMX$hits) ){
+       print(paste0(chr, ": Set of contacts per tissue not consistent."), quote=FALSE)
+       next
+     }
+     rm(PERSIST.MX, newPMX, ct.v); gc()
+     print(paste0(chr, " done!"), quote=FALSE)
+   }
+   
+ }
[1] getMELTMXpersist: 12484769 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr1 done!
[1] getMELTMXpersist: 15065875 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr2 done!
[1] getMELTMXpersist: 10580273 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr3 done!
[1] getMELTMXpersist: 9794079 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr4 done!
[1] getMELTMXpersist: 8739179 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr5 done!
[1] getMELTMXpersist: 7933716 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr6 done!
[1] getMELTMXpersist: 6570200 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr7 done!
[1] getMELTMXpersist: 5809775 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr8 done!
[1] getMELTMXpersist: 3414236 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr9 done!
[1] getMELTMXpersist: 4861513 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr10 done!
[1] getMELTMXpersist: 4849690 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr11 done!
[1] getMELTMXpersist: 4864376 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr12 done!
[1] getMELTMXpersist: 2747531 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr13 done!
[1] getMELTMXpersist: 2295141 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr14 done!
[1] getMELTMXpersist: 1868525 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr15 done!
[1] getMELTMXpersist: 1609419 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr16 done!
[1] getMELTMXpersist: 1679793 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr17 done!
[1] getMELTMXpersist: 1701273 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr18 done!
[1] getMELTMXpersist: 827110 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr19 done!
[1] getMELTMXpersist: 1036538 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr20 done!
[1] getMELTMXpersist: 357406 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr21 done!
[1] getMELTMXpersist: 334372 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chr22 done!
[1] getMELTMXpersist: 5977841 entries remained after the provided value cuttof that occured in at least 100% data, in at least 1 tissues.
[1] chrX done!
[[1]]
NULL

> ### END OF PARALLEL EXECUTION ###
> 
> # rm(list=ls()); gc()
> 
CBB Profiling started Mon Jan 24 11:47:34 2022
SLURM_JOB_ID		3717629
REQ_CPU_CORES		1
REQ_MEMORY_GB		15.000000
Starting profiling...

                                                                                
                                                                                
                                    CPU (cores)                                 
    1 +---------------------------------------------------------------------+   
      |####  #####################################+        +       +        |   
      |#                                         ###########################|   
      |#                                                                    |   
      |                                                                     |   
  0.8 |-+                                                                 +-|   
      |                                                                     |   
      |                                                                     |   
      |                                                                     |   
  0.6 |-+                                                                 +-|   
      |                                                                     |   
      |                                                                     |   
      |                                                                     |   
      |                                                                     |   
  0.4 |-+                                                                 +-|   
      |                                                                     |   
      |                                                                     |   
      |                                                                     |   
  0.2 |-+                                                                 +-|   
      |                                                                     |   
      |                                                                     |   
      |                                                                     |   
      |        +        +       +        +        +        +       +        |   
    0 +---------------------------------------------------------------------+   
      0       200      400     600      800      1000     1200    1400     1600 
                                Job profiling step                              
                                                                                

                                                                                
                                                                                
                                   Memory (GB)                                  
  16 +----------------------------------------------------------------------+   
     |**********************************************************************|   
     |                 ##                                                   |   
  14 |-+          #    ##                                                 +-|   
     |            #    ##                                                   |   
     |    #    #  #    ## #                                                 |   
  12 |-+  ##   #  #    ## #  #                                            +-|   
     |    ##   #  #    ## #  ##                                             |   
     |    ##   # ##    ####  ##    #                                        |   
  10 |-+  ##   # ###   ####  ##    # #      #                             +-|   
     |   ###   # # #   ####  ####  # #  #   #   #                           |   
   8 |-+ ###   # # #   ####  ####  # # ###  #   #   #                     +-|   
     |   # #  ## # #   ####  ####  ### ###  # # #   #                      #|   
     |  ## #  ## # #  #####  ####  ### ###  # # ##  #                      #|   
   6 |-+## #  ## # #### #########  ### ######## ##  #    #  #  #          +#|   
     |  #  #  ####      ##    ############  ######### #  ## #  #         # #|   
     | ##  ######       ##    ##   ##   ##  ##  ##  #### ## ## #         ###|   
   4 |-#       ##       ##    ##   ##   ##  ##  ##  #### ######## #      #+-|   
     |##       ##       ##    ##   ##   ##  ##  ##  # ##### ## ## ##    ##  |   
     |#        ##                  ##                 ## ## ## ##########   |   
   2 |#+                                                                  +-|   
     |                                                                      |   
     |        +        +        +        +       +        +        +        |   
   0 +----------------------------------------------------------------------+   
     0       200      400      600      800     1000     1200     1400     1600 
                               Job profiling step                               
                                                                                

                                                                                
                                                                                
                                  Data read (GB)                                
  4.5 +---------------------------------------------------------------------+   
      |        +        +       +        +        +        +       +       #|   
      |                                                                #####|   
    4 |-+                                                           ####  +-|   
      |                                                           ###       |   
  3.5 |-+                                                      ####       +-|   
      |                                                     ####            |   
      |                                                  ####               |   
    3 |-+                                            #####                +-|   
      |                                          #####                      |   
  2.5 |-+                                    #####                        +-|   
      |                                     ##                              |   
      |                                  ####                               |   
    2 |-+                           ######                                +-|   
      |                            ##                                       |   
  1.5 |-+                      #####                                      +-|   
      |                      ###                                            |   
      |                  #####                                              |   
    1 |-+              ###                                                +-|   
      |          #######                                                    |   
  0.5 |-+       ##                                                        +-|   
      | #########                                                           |   
      |##      +        +       +        +        +        +       +        |   
    0 +---------------------------------------------------------------------+   
      0       200      400     600      800      1000     1200    1400     1600 
                                Job profiling step                              
                                                                                

                                                                                
                                                                                
                                 Data written (GB)                              
  3.5 +---------------------------------------------------------------------+   
      |        +        +       +        +        +        +       +        |   
      |                                                                     |   
    3 |-+                                                                 ##|   
      |                                                               ##### |   
      |                                                            ####     |   
      |                                                         ####        |   
  2.5 |-+                                                     ###         +-|   
      |                                                    ####             |   
      |                                               ######                |   
    2 |-+                                          ####                   +-|   
      |                                        #####                        |   
      |                                     ####                            |   
  1.5 |-+                                 ##                              +-|   
      |                               #####                                 |   
      |                           #####                                     |   
    1 |-+                        ##                                       +-|   
      |                     ######                                          |   
      |                    ##                                               |   
      |              #######                                                |   
  0.5 |-+           ##                                                    +-|   
      |       #######                                                       |   
      |     ###+        +       +        +        +        +       +        |   
    0 +---------------------------------------------------------------------+   
      0       200      400     600      800      1000     1200    1400     1600 
                                Job profiling step                              
                                                                                
